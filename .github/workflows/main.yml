name: Simple Build WebViewTvLive

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 35
        build-tools: 35.0.0
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x gradlew
      
    - name: Check project structure
      run: |
        echo "📁 Project structure:"
        ls -la
        echo ""
        echo "📁 App directory:"
        ls -la app/ 2>/dev/null || echo "No app directory found"
        echo ""
        echo "📄 Gradle files:"
        find . -name "*.gradle*" -type f | head -10
        
    - name: Fix build configuration
      run: |
        echo "🔧 Applying build fixes..."
        
        # Update gradle.properties
        cat >> gradle.properties << 'EOF'
        
        # Build configuration fixes
        android.compileSdk=35
        android.targetSdk=34
        android.buildToolsVersion=35.0.0
        android.useAndroidX=true
        android.enableJetifier=true
        
        # Performance settings
        org.gradle.jvmargs=-Xmx3072m -Dfile.encoding=UTF-8
        org.gradle.parallel=true
        org.gradle.caching=true
        org.gradle.daemon=true
        
        # Suppress warnings
        android.suppressUnsupportedCompileSdk=35
        EOF
        
        echo "📝 Updated gradle.properties:"
        cat gradle.properties
        
    - name: Clean project
      run: |
        echo "🧹 Cleaning project..."
        ./gradlew clean --stacktrace
      
    - name: Build debug APK
      run: |
        echo "🔨 Building debug APK..."
        ./gradlew assembleDebug --stacktrace --info --no-daemon
        
    - name: Check build outputs
      run: |
        echo "📦 Checking build outputs..."
        find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
        
        if [ -d "app/build/outputs" ]; then
          echo "📁 Contents of app/build/outputs:"
          find app/build/outputs -type f | head -20
        else
          echo "❌ No outputs directory found"
        fi
        
        # Check for common build directories
        for dir in build app/build; do
          if [ -d "$dir" ]; then
            echo "📁 Contents of $dir:"
            ls -la "$dir" | head -10
          fi
        done
        
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: apk-files
        path: |
          **/build/outputs/apk/**/*.apk
          **/*.apk
        retention-days: 7
        if-no-files-found: warn
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: |
          **/build/reports/
          **/build/tmp/
          gradle.properties
        retention-days: 3
        if-no-files-found: ignore
